name: Build and Test

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  workflow_dispatch: {}

jobs:
  build_and_test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          #- { node: '14', upload: '-node14' }
          - { node: '16', upload: '' }
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Install Node
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node }}
          cache: npm
          cache-dependency-path: 'src/*/package-lock.json'
      - name: Build and Test
        run: PARALLEL_BUILD=false PARALLEL_E2E=false E2E_LAUNCH_DELAY=5 EXPLICIT_WAIT_TIMEOUT=20000 TEST_TIMEOUT=60000 npm test
      - name: Bundle
        run: |
          cd build
          rm -r node_modules
          tar -czf ../build.tar.gz .
      - name: Upload Bundle
        if: ${{ matrix.upload != null }}
        uses: actions/upload-artifact@v2
        with:
          name: refacto${{ matrix.upload }}
          retention-days: 1
          if-no-files-found: error
          path: build.tar.gz

  smoke_test:
    needs:
      - build_and_test
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - { node: '14' }
          - { node: '16' }
    steps:
      - name: Install Node
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node }}
      - name: Download Bundle
        uses: actions/download-artifact@v2
        with:
          name: refacto
      - name: Unpack
        run: |
          ls -al
          tar -xf build.tar.gz
          rm build.tar.gz
      - name: Smoke Test
        run: |
          npm install --production
          npm start > stdout.log & PID=$!
          sleep 3
          if ! grep 'Available at' <stdout.log >/dev/null; then
            cat stdout.log
            echo "Application failed to launch" >&2
            exit 1
          fi
          kill -2 "$PID"
          sleep 1
          if ! grep 'Shutdown complete' <stdout.log >/dev/null; then
            cat stdout.log
            echo "Application failed to shut down" >&2
            exit 1
          fi
